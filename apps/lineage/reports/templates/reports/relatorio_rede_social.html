{% extends "layouts/base.html" %}
{% load humanize i18n %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
{% endblock extrastyle %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "Dashboard" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'reports:dashboard' %}">{% trans "Relatórios" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Relatório da Rede Social" %}</li>
{% endblock breadcrumbs %}

{% block page_header %}
<h5 class="display-5">{% trans "Relatório da Rede Social" %}</h5>
{% endblock page_header %}

{% block content %}
<div class="reports-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="report-container">
          <div class="report-header">
            <h1 class="report-title">
              <i class="fas fa-users me-3"></i>
              {% trans "Relatório da Rede Social" %}
            </h1>
            <p class="reports-subtitle">
              {% trans "Analise engajamento, usuários mais ativos, posts populares e estatísticas completas da rede social." %}
            </p>
          </div>
          
          <div class="report-body">
            <!-- Resumo Geral da Rede Social -->
            <div class="row g-4 mb-4">
              <div class="col-md-3">
                <div class="status-block bg-primary text-white p-3 rounded shadow">
                  <i class="fas fa-file-alt fa-2x mb-2"></i>
                  <h5>{% trans "Total de Posts" %}</h5>
                  <h4>{{ total_posts|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-success text-white p-3 rounded shadow">
                  <i class="fas fa-heart fa-2x mb-2"></i>
                  <h5>{% trans "Total de Curtidas" %}</h5>
                  <h4>{{ total_likes|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-info text-white p-3 rounded shadow">
                  <i class="fas fa-comments fa-2x mb-2"></i>
                  <h5>{% trans "Total de Comentários" %}</h5>
                  <h4>{{ total_comments|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-warning text-white p-3 rounded shadow">
                  <i class="fas fa-share fa-2x mb-2"></i>
                  <h5>{% trans "Total de Compartilhamentos" %}</h5>
                  <h4>{{ total_shares|intcomma }}</h4>
                </div>
              </div>
            </div>

            <!-- Segunda linha de estatísticas -->
            <div class="row g-4 mb-4">
              <div class="col-md-3">
                <div class="status-block bg-secondary text-white p-3 rounded shadow">
                  <i class="fas fa-users fa-2x mb-2"></i>
                  <h5>{% trans "Usuários Ativos" %}</h5>
                  <h4>{{ total_users|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-dark text-white p-3 rounded shadow">
                  <i class="fas fa-user-plus fa-2x mb-2"></i>
                  <h5>{% trans "Conexões" %}</h5>
                  <h4>{{ total_follows|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-danger text-white p-3 rounded shadow">
                  <i class="fas fa-hashtag fa-2x mb-2"></i>
                  <h5>{% trans "Hashtags" %}</h5>
                  <h4>{{ total_hashtags|intcomma }}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="status-block bg-light text-dark p-3 rounded shadow">
                  <i class="fas fa-calendar-day fa-2x mb-2"></i>
                  <h5>{% trans "Posts (30 dias)" %}</h5>
                  <h4>{{ posts_30_dias|intcomma }}</h4>
                </div>
              </div>
            </div>

            <!-- Gráfico de Posts por Dia -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-chart-line reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Posts por Dia (Últimos 30 dias)" %}</h2>
                <p class="reports-card-description">
                  {% trans "Evolução da atividade na rede social ao longo do tempo" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="chart-container" style="height: 400px;">
                  <canvas id="postsPorDia"></canvas>
                </div>
              </div>
            </div>

            <!-- Usuários Mais Ativos -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-trophy reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Usuários Mais Ativos" %}</h2>
                <p class="reports-card-description">
                  {% trans "Top 10 usuários com mais posts e engajamento" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="table-responsive">
                  <table class="table report-table">
                    <thead>
                      <tr>
                        <th><i class="fas fa-user me-2"></i>{% trans "Usuário" %}</th>
                        <th><i class="fas fa-file-alt me-2"></i>{% trans "Posts" %}</th>
                        <th><i class="fas fa-heart me-2"></i>{% trans "Curtidas Recebidas" %}</th>
                        <th><i class="fas fa-comments me-2"></i>{% trans "Comentários Recebidos" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for usuario in usuarios_mais_ativos %}
                        <tr>
                          <td>
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>{{ usuario.author__username }}</strong>
                          </td>
                          <td>
                            <span class="badge bg-primary">{{ usuario.total_posts }}</span>
                          </td>
                          <td>
                            <span class="badge bg-success">{{ usuario.total_likes_received|default:0 }}</span>
                          </td>
                          <td>
                            <span class="badge bg-info">{{ usuario.total_comments_received|default:0 }}</span>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Posts Mais Populares -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-fire reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Posts Mais Populares" %}</h2>
                <p class="reports-card-description">
                  {% trans "Posts com maior engajamento (likes + comentários + compartilhamentos)" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="table-responsive">
                  <table class="table report-table">
                    <thead>
                      <tr>
                        <th><i class="fas fa-user me-2"></i>{% trans "Autor" %}</th>
                        <th><i class="fas fa-file-alt me-2"></i>{% trans "Conteúdo" %}</th>
                        <th><i class="fas fa-heart me-2"></i>{% trans "Curtidas" %}</th>
                        <th><i class="fas fa-comments me-2"></i>{% trans "Comentários" %}</th>
                        <th><i class="fas fa-share me-2"></i>{% trans "Compartilhamentos" %}</th>
                        <th><i class="fas fa-calendar me-2"></i>{% trans "Data" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for post in posts_mais_populares %}
                        <tr>
                          <td>
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>{{ post.author.username }}</strong>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 300px;" title="{{ post.content }}">
                              {{ post.content|truncatechars:100 }}
                            </div>
                          </td>
                          <td>
                            <span class="badge bg-success">{{ post.likes_count }}</span>
                          </td>
                          <td>
                            <span class="badge bg-info">{{ post.comments_count }}</span>
                          </td>
                          <td>
                            <span class="badge bg-warning">{{ post.shares_count }}</span>
                          </td>
                          <td>
                            <small>{{ post.created_at|date:"d/m/Y H:i" }}</small>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Hashtags Mais Populares -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-hashtag reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Hashtags Mais Populares" %}</h2>
                <p class="reports-card-description">
                  {% trans "Hashtags com maior uso e engajamento" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="chart-container">
                      <canvas id="hashtagsPopulares"></canvas>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="table-responsive">
                      <table class="table report-table">
                        <thead>
                          <tr>
                            <th><i class="fas fa-hashtag me-2"></i>{% trans "Hashtag" %}</th>
                            <th><i class="fas fa-file-alt me-2"></i>{% trans "Posts" %}</th>
                            <th><i class="fas fa-heart me-2"></i>{% trans "Curtidas" %}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for hashtag in hashtags_populares %}
                            <tr>
                              <td>
                                <i class="fas fa-hashtag text-danger me-2"></i>
                                <strong>#{{ hashtag.hashtag__name }}</strong>
                              </td>
                              <td>
                                <span class="badge bg-primary">{{ hashtag.total_posts }}</span>
                              </td>
                              <td>
                                <span class="badge bg-success">{{ hashtag.total_likes|default:0 }}</span>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Estatísticas de Conteúdo -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-chart-pie reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Tipos de Conteúdo" %}</h2>
                <p class="reports-card-description">
                  {% trans "Distribuição dos tipos de conteúdo na rede social" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="row g-4">
                  <div class="col-md-3">
                    <div class="text-center">
                      <i class="fas fa-image fa-3x text-primary mb-2"></i>
                      <h5>{% trans "Posts com Imagem" %}</h5>
                      <h4 class="text-primary">{{ posts_com_imagem|intcomma }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <i class="fas fa-video fa-3x text-success mb-2"></i>
                      <h5>{% trans "Posts com Vídeo" %}</h5>
                      <h4 class="text-success">{{ posts_com_video|intcomma }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <i class="fas fa-link fa-3x text-info mb-2"></i>
                      <h5>{% trans "Posts com Link" %}</h5>
                      <h4 class="text-info">{{ posts_com_link|intcomma }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <i class="fas fa-thumbtack fa-3x text-warning mb-2"></i>
                      <h5>{% trans "Posts Fixados" %}</h5>
                      <h4 class="text-warning">{{ posts_fixados|intcomma }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reações por Tipo -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-smile reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Reações por Tipo" %}</h2>
                <p class="reports-card-description">
                  {% trans "Distribuição dos tipos de reações dos usuários" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="chart-container" style="height: 400px;">
                  <canvas id="reacoesPorTipo"></canvas>
                </div>
              </div>
            </div>

            <!-- Usuários Mais Influentes -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-crown reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Usuários Mais Influentes" %}</h2>
                <p class="reports-card-description">
                  {% trans "Usuários com maior número de seguidores" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="table-responsive">
                  <table class="table report-table">
                    <thead>
                      <tr>
                        <th><i class="fas fa-user me-2"></i>{% trans "Usuário" %}</th>
                        <th><i class="fas fa-users me-2"></i>{% trans "Seguidores" %}</th>
                        <th><i class="fas fa-user-plus me-2"></i>{% trans "Seguindo" %}</th>
                        <th><i class="fas fa-file-alt me-2"></i>{% trans "Posts" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for usuario in usuarios_influentes %}
                        <tr>
                          <td>
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>{{ usuario.user.username }}</strong>
                          </td>
                          <td>
                            <span class="badge bg-success">{{ usuario.followers_count }}</span>
                          </td>
                          <td>
                            <span class="badge bg-info">{{ usuario.following_count }}</span>
                          </td>
                          <td>
                            <span class="badge bg-primary">{{ usuario.posts_count }}</span>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Comentários Mais Curtidos -->
            <div class="reports-card">
              <div class="reports-card-header">
                <i class="fas fa-comment-dots reports-icon"></i>
                <h2 class="reports-card-title">{% trans "Comentários Mais Curtidos" %}</h2>
                <p class="reports-card-description">
                  {% trans "Comentários com maior engajamento" %}
                </p>
              </div>
              <div class="reports-card-body">
                <div class="table-responsive">
                  <table class="table report-table">
                    <thead>
                      <tr>
                        <th><i class="fas fa-user me-2"></i>{% trans "Autor" %}</th>
                        <th><i class="fas fa-comment me-2"></i>{% trans "Comentário" %}</th>
                        <th><i class="fas fa-heart me-2"></i>{% trans "Curtidas" %}</th>
                        <th><i class="fas fa-file-alt me-2"></i>{% trans "Post" %}</th>
                        <th><i class="fas fa-calendar me-2"></i>{% trans "Data" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for comentario in comentarios_populares %}
                        <tr>
                          <td>
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>{{ comentario.author.username }}</strong>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 300px;" title="{{ comentario.content }}">
                              {{ comentario.content|truncatechars:100 }}
                            </div>
                          </td>
                          <td>
                            <span class="badge bg-success">{{ comentario.likes_count }}</span>
                          </td>
                          <td>
                            <small>{{ comentario.post.content|truncatechars:50 }}</small>
                          </td>
                          <td>
                            <small>{{ comentario.created_at|date:"d/m/Y H:i" }}</small>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para os gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Posts por Dia
    const ctxPosts = document.getElementById('postsPorDia').getContext('2d');
    const postsLabels = {{ posts_por_dia_labels|safe }};
    const postsValues = {{ posts_por_dia_values|safe }};
    
    if (postsLabels.length > 0 && postsValues.length > 0) {
        new Chart(ctxPosts, {
            type: 'line',
            data: {
                labels: postsLabels,
                datasets: [{
                    label: 'Posts',
                    data: postsValues,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Evolução de Posts por Dia'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    } else {
        // Mostrar mensagem quando não há dados
        ctxPosts.font = '16px Arial';
        ctxPosts.fillStyle = '#666';
        ctxPosts.textAlign = 'center';
        ctxPosts.fillText('Nenhum dado disponível para o período', ctxPosts.canvas.width / 2, ctxPosts.canvas.height / 2);
    }

    // Gráfico de Hashtags Populares
    const ctxHashtags = document.getElementById('hashtagsPopulares').getContext('2d');
    const hashtagsLabels = {{ hashtags_labels|safe }};
    const hashtagsValues = {{ hashtags_values|safe }};
    
    if (hashtagsLabels.length > 0 && hashtagsValues.length > 0) {
        new Chart(ctxHashtags, {
            type: 'doughnut',
            data: {
                labels: hashtagsLabels,
                datasets: [{
                    data: hashtagsValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Hashtags Mais Populares'
                }
            }
        }
    });
    } else {
        // Mostrar mensagem quando não há dados
        ctxHashtags.font = '16px Arial';
        ctxHashtags.fillStyle = '#666';
        ctxHashtags.textAlign = 'center';
        ctxHashtags.fillText('Nenhuma hashtag disponível', ctxHashtags.canvas.width / 2, ctxHashtags.canvas.height / 2);
    }

    // Gráfico de Reações por Tipo
    const ctxReacoes = document.getElementById('reacoesPorTipo').getContext('2d');
    const reacoesLabels = {{ reacoes_labels|safe }};
    const reacoesValues = {{ reacoes_values|safe }};
    
    if (reacoesLabels.length > 0 && reacoesValues.length > 0) {
        new Chart(ctxReacoes, {
            type: 'bar',
            data: {
                labels: reacoesLabels,
                datasets: [{
                    label: 'Quantidade',
                    data: reacoesValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Distribuição de Reações'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    } else {
        // Mostrar mensagem quando não há dados
        ctxReacoes.font = '16px Arial';
        ctxReacoes.fillStyle = '#666';
        ctxReacoes.textAlign = 'center';
        ctxReacoes.fillText('Nenhuma reação disponível', ctxReacoes.canvas.width / 2, ctxReacoes.canvas.height / 2);
    }
});
</script>
{% endblock %}
